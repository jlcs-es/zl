<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="error.css">

  <script>
    // Activar debug:
    this.zl = {log : function() { console.log.apply(console, arguments); }};
  </script>

  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="http://jsbeautifier.org/js/lib/beautify.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/async/1.5.0/async.min.js"></script>
  <script src="codemirror.js"></script>
  <script src="filesaver.js"></script>
  <script src="jszip.js"></script>
  <script src="jsziputils.js"></script>
  <script src="https://codemirror.net/addon/mode/simple.js"></script>
  <link rel="stylesheet" href="codemirror.css">
  <script src="utils.js"></script>
  <script src="analizador.js"></script>
  <script src="zlsintaxis.js"></script>
  <script src="ejecucion.js"></script>
  <script src="error.js"></script>
  <script src="configuracion.js"></script>
  <script src="sintaxis.js"></script>
  <script src="entorno.js"></script>
  <script src="semantica.js"></script>
  <script src="compilador.js"></script>
  <script src="javascript.js"></script>
  <script src="editor.js"></script>
  <script src="https://skalman.github.io/UglifyJS-online/uglify/lib/utils.js"></script>
  <script src="https://skalman.github.io/UglifyJS-online/uglify/lib/ast.js"></script>
  <script src="https://skalman.github.io/UglifyJS-online/uglify/lib/parse.js"></script>
  <script src="https://skalman.github.io/UglifyJS-online/uglify/lib/transform.js"></script>
  <script src="https://skalman.github.io/UglifyJS-online/uglify/lib/scope.js"></script>
  <script src="https://skalman.github.io/UglifyJS-online/uglify/lib/output.js"></script>
  <script src="https://skalman.github.io/UglifyJS-online/uglify/lib/compress.js"></script>
  <script>
  var default_options = {};

  function uglify(code) {
    var options = {};
    // Create copies of the options
    var parse_options = defaults({}, options.parse);
    var compress_options = defaults({}, options.compress);
    var output_options = defaults({}, options.output);

    parse_options = defaults(parse_options, default_options.parse, true);
    compress_options = defaults(compress_options, default_options.compress, true);
    output_options = defaults(output_options, default_options.output, true);

    // 1. Parse
    var toplevel_ast = parse(code, parse_options);
    toplevel_ast.figure_out_scope();

    // 2. Compress
    var compressor = new Compressor(compress_options);
    var compressed_ast = toplevel_ast.transform(compressor);

    // 3. Mangle
    compressed_ast.figure_out_scope();
    compressed_ast.compute_char_frequency();
    compressed_ast.mangle_names();

    // 4. Generate output
    code = compressed_ast.print_to_string(output_options);

    return code;
  }
</script>
</head>

<body>
  <div class="main">
<textarea class="editor" id="editor">
Subrutina Externa Inicio
Datos
  piramide es Texto
  tam es Numero
  i es Numero
Algoritmo
  mostrar [ mensaje <- "Escribe el tamaño de la pirámide" ]
  leerNumero [ mensaje -> tam ]
  // Cambiar a piramide <- ""
  piramide <- 0 + 1 + 2
  i <- 1
	Mientras i <= tam hacer
    // Pulsa Ctrl+F9 y selecciona 'piramide'
    piramide <- piramide + (" "*((tam-i)*0.5)) + ("#"*i) + (" "*((tam-i)*0.5))
    piramide <- piramide + "\n"
    i <- i + 2
    pausar
  Fin
  mostrar [ mensaje <- "<marquee>" + piramide + "</marquee>" ]
Fin</textarea>
    <div class="v divisor"></div>
    <div class="compilation">
      <div class="helparea" id="helparea" readonly="readonly"></div>
      <div class="h divisor"></div>
      <div class="output" id="output"></div>
      <input type="text" class="input" id="input" disabled="disabled">
      <div style="display: flex;">
        <button class="run" id="run">
          Empezar
        </button>
        <button class="continue" id="continue" disabled="disabled">
          Continuar
        </button>
      </div>
    </div>

    <script>

      var editor = CodeMirror.fromTextArea($("#editor").get(0), {
        lineNumbers: true,
        mode: "zl",
        tabSize: 2,
        identWithTabs: false,
        smartIdent: true,
      });
      editor.on("change", function() {
        if (lasttimeout) {
          clearTimeout(lasttimeout);
        }
        lasttimeout = setTimeout(Compile, 500, editor.getValue());
      });
      editor.on("cursorActivity", function(){setTimeout(evaluar,20); return true;});

      var evaluando = false;
      editor.addKeyMap({
        "Ctrl-S": download,
        "Cmd-S": download,
        "Ctrl-F9": function(){evaluando = !evaluando;},
        "Cmd-F9": function(){evaluando = !evaluando;}
      });

      function saltarAlCodigo(linea, posicion) {
        "use strict";
        editor.setCursor(linea,posicion);
        editor.focus();
        return true;
      }

      var lastjs = "";
      var lasttimeout = null;
      var minify = false;

      var carga = null;
      $("#run").click(function() {
        var compilation = $("#helparea").get(0);
        var zlcode = editor.getValue();
        if (!carga) {
          $("#run").html("Abortar");
          carga = zl.Cargar(lastjs);
          carga.$alAcabar = function() {
            carga = null;
            $("#run").html("Empezar");
          }
          try {
            zl.Ejecutar(carga);
          } catch (e) {
            if (zl.error.esError(e))
              compilation.innerHTML = zl.error.obtenerMensaje(e, zlcode);
            else
              throw e;
          }
        } else {
          zl.Abortar(carga);
          carga = null;

          $("#run").html("Empezar");
          compilation.innerHTML = "";
        }
      });

      var continuarCallback;
      var ultimoArg;
      var ultimoEntorno;
      $("#continue").click(function() {
        $("#continue").prop('disabled', true);
        ultimoEntorno = null;
        continuarCallback(null, ultimoArg);
      });

      var lastCompilation;
      function Compile(zlcode) {
        lasttimeout = null;
        var compilation = $("#helparea").get(0);
        try {
          lastCompilation = zl.Compilar(zlcode);
          if (minify)
            lastjs = js_beautify(uglify(js_beautify(lastCompilation.javascript)));
          else
            lastjs = js_beautify(lastCompilation.javascript);
          compilation.innerHTML = textToHtml(lastjs);

        } catch (e) {
          if (zl.error.esError(e))
            compilation.innerHTML = zl.error.obtenerMensajeHtml(e, zlcode).getHtml();
          else
            throw e;
        }
      }
      Compile(editor.getValue());

      function download() {
        var zip = new JSZip();
        zip.file("codigo.zl",editor.getValue());
        zip.file("zl.comp.js", lastjs);
        zip.file("estilo.css", zipestilo);
        zip.file("ejecucion.js", zipejecucion);
        zip.file("arrastrame a google chrome o firefox.html", zipindex);

        var content = zip.generate({type: "blob"});
        saveAs(content, "programa.zip");
      }

      var isBottom = true;
      $("#output").get(0).onscroll = function(ev) {
        $this = $("#output");
        var t = $this.get(0);
        isBottom = (t.scrollTop+$this.innerHeight() >= t.scrollHeight);
      };

      zl.io = zl.io || {};

      zl.io.outWrite = function(html) {
        var t = $("#output").get(0);
        t.innerHTML += textToHtml(html)
        if (isBottom) {
          t.scrollTop = t.scrollHeight;
        }
      }

      zl.io.inRead = function(callback) {
        $("#input").prop("disabled",false);
        $("#input").keypress(function (e) {
          if (e.which == 13) {
            $(this).off("keypress");
            var v = $("#input").val();
            $("#input").val("");
            $("#input").prop('disabled', true);
            callback(null, v);
          }
        });
        $("#input").focus();
        evaluar();
      }

      zl.io.abortRead = function() {
        $("#input").off("keypress");
        $("#input").val("");
        $("#input").prop('disabled', true);
      }

      zl.io.limpiar = function() {
        $("#output").get(0).innerHTML = "";
      }

      zl.io.pause = function(arg, entorno, callback) {
        $("#continue").prop('disabled', false);
        continuarCallback = callback;
        ultimoEntorno = entorno;
        ultimoArg = arg;
        evaluar();
      }

      zl.io.abortPause = function() {
        $("#continue").prop('disabled', true);
      }

      function evaluar() {
        if (evaluando && carga && lastCompilation && ultimoEntorno) {
          var subrutina = lastCompilation.tabla.subrutinaPorPosicion(editor.getCursor().ch);
          var compilation = $("#helparea").get(0);
          compilation.innerHTML = "La expresión \n\t"+editor.getSelection()+"\n"+
            "Equivale a:\n"+zl.Evaluar(editor.getSelection(), subrutina, carga, ultimoEntorno);
        }
      }

      function textToHtml(text) {
        return text.replace(/\n/g, "<br>").replace(/ /g, "&nbsp;");
      }

      var zipindex;
      var zipestilo;
      $.ajax("entornoEjecucion/estilo.css",{
        dataType: "text",
        type: "get",
        success: function(data) {
          zipestilo = data;
        }
      });

      $.ajax("entornoEjecucion/index.html",{
        dataType: "text",
        type: "get",
        success: function(data) {
          zipindex = data;
        }
      });

      $.ajax("ejecucion.js",{
        dataType: "text",
        type: "get",
        success: function(data) {
          zipejecucion = data;
        }
      });
    </script>
</body>

</html>
