<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="error.css">

  <script>
    // Activar debug:
    this.zl = {log : function() { console.log.apply(console, arguments); }};
  </script>

  <script src="terceros/jquery-2.1.4.min.js"></script>
  <script src="terceros/beautify.js"></script>
  <script src="terceros/async.min.js"></script>
  <script src="terceros/codemirror.js"></script>
  <script src="terceros/filesaver.js"></script>
  <script src="terceros/jszip.js"></script>
  <script src="terceros/jsziputils.js"></script>
  <script src="terceros/addon/mode/simple.js"></script>
  <script src="terceros/addon/selection/active-line.js"></script>
  <script src="terceros/matchbrackets.js"></script>
  <script src="terceros/show-hint.js"></script>
  <link rel="stylesheet" href="terceros/codemirror.css">
  <link rel="stylesheet" href="terceros/addon/hint/show-hint.css">
  <script src="utils.js"></script>
  <script src="analizador.js"></script>
  <script src="zlsintaxis.js"></script>
  <script src="ejecucion.js"></script>
  <script src="error.js"></script>
  <script src="configuracion.js"></script>
  <script src="sintaxis.js"></script>
  <script src="entorno.js"></script>
  <script src="semantica.js"></script>
  <script src="compilador.js"></script>
  <script src="javascript.js"></script>
  <script src="editor.js"></script>
  <script src="autocompletar.js"></script>
  <script src="terceros/uglifyjs/utils.js"></script>
  <script src="terceros/uglifyjs/ast.js"></script>
  <script src="terceros/uglifyjs/parse.js"></script>
  <script src="terceros/uglifyjs/transform.js"></script>
  <script src="terceros/uglifyjs/scope.js"></script>
  <script src="terceros/uglifyjs/output.js"></script>
  <script src="terceros/uglifyjs/compress.js"></script>
  <script>
  var default_options = {};

  function uglify(code) {
    var options = {};
    // Create copies of the options
    var parse_options = defaults({}, options.parse);
    var compress_options = defaults({}, options.compress);
    var output_options = defaults({}, options.output);

    parse_options = defaults(parse_options, default_options.parse, true);
    compress_options = defaults(compress_options, default_options.compress, true);
    output_options = defaults(output_options, default_options.output, true);

    // 1. Parse
    var toplevel_ast = parse(code, parse_options);
    toplevel_ast.figure_out_scope();

    // 2. Compress
    var compressor = new Compressor(compress_options);
    var compressed_ast = toplevel_ast.transform(compressor);

    // 3. Mangle
    compressed_ast.figure_out_scope();
    compressed_ast.compute_char_frequency();
    compressed_ast.mangle_names();

    // 4. Generate output
    code = compressed_ast.print_to_string(output_options);

    return code;
  }
</script>
</head>

<body onresize="return canvasEscala();">
  <div class="main">
<textarea class="editor" id="editor">Configuracion
  fps <- 60
Fin

Subrutina Primitiva Fondo
Datos
  r es Numero de Entrada
  g es Numero de Entrada
  b es Numero de Entrada
Algoritmo
  /*
  var c = document.getElementById("canvas");
  var ctx = c.getContext("2d");
  ctx.fillStyle = "rgba("+~~$entrada.r+","+~~$entrada.g+","+~~$entrada.b+",255)";
  ctx.fillRect(0, 0, c.width, c.height);
  */
Fin

Subrutina Primitiva Elipse
Datos
  centrox es Numero de Entrada
  centroy es Numero de Entrada
  ancho es Numero de Entrada
  alto es Numero de Entrada
Algoritmo
  /*
  var c = document.getElementById("canvas");
  var ctx = c.getContext("2d");
  var w = $entrada.ancho >= 0 ? $entrada.ancho : 0;
	var h = $entrada.alto >= 0 ? $entrada.alto : 0;
  var x = $entrada.centrox;
  var y = $entrada.centroy;
	ctx.beginPath();
	if (w == h) {
		ctx.arc(x,y,w / 2, 0, 6.283185307179586, false);
	} else {
		var w2 = w/2;
		var h2 = h/2;
		x -= w2;
		y -= h2;
		var kappa = 0.5522848,
		ox = (w2) * kappa, // control point offset horizontal
		oy = (h2) * kappa, // control point offset vertical
		xe = x + w,           // x-end
		ye = y + h,           // y-end
		xm = x + w2,       // x-middle
		ym = y + h2;       // y-middle

		ctx.moveTo(x, ym);
		ctx.bezierCurveTo(x, ym - oy, xm - ox, y, xm, y);
		ctx.bezierCurveTo(xm + ox, y, xe, ym - oy, xe, ym);
		ctx.bezierCurveTo(xe, ym + oy, xm + ox, ye, xm, ye);
		ctx.bezierCurveTo(xm - ox, ye, x, ym + oy, x, ym);
	}
	ctx.closePath();
  if ($global.$estiloRelleno) {
    //ctx.globalAlpha = fillAlpha;
    ctx.fill();
  }
  if ($global.$estiloBordes) {
    //ctx.globalAlpha = strokeAlpha;
    ctx.stroke();
  }
  */
Fin

Subrutina Primitiva rectangulo
Datos
  posx es Numero de Entrada
  posy es Numero de Entrada
  ancho es Numero de Entrada
  alto es Numero de Entrada
Algoritmo
  /*
  var c = document.getElementById("canvas");
  var ctx = c.getContext("2d");
  var w = $entrada.ancho >= 0 ? $entrada.ancho : 0;
  var h = $entrada.alto >= 0 ? $entrada.alto : 0;
  //if (lineWidth % 2 == 1) ctx.translate(0.5,0.5);
  ctx.beginPath();
  ctx.rect($entrada.posx,$entrada.posy,w,h);
  ctx.closePath();
  if ($global.$estiloRelleno) {
    //ctx.globalAlpha = fillAlpha;
    ctx.fill();
  }
  if ($global.$estiloBordes) {
    //ctx.globalAlpha = strokeAlpha;
    ctx.stroke();
  }
  //if (lineWidth % 2 == 1) ctx.translate(-0.5,-0.5);
  */
Fin

Subrutina Primitiva colorRelleno
Datos
  r es Numero de Entrada
  g es Numero de Entrada
  b es Numero de Entrada
Algoritmo
  /*
  var c = document.getElementById("canvas");
  var ctx = c.getContext("2d");
  ctx.fillStyle = "rgb("+~~$entrada.r+","+~~$entrada.g+","+~~$entrada.b+")";
  $global.$estiloRelleno = {
    r: $entrada.r,
    g: $entrada.g,
    b: $entrada.b
  };
  */
Fin

Subrutina Primitiva grosorBorde
Datos
	grosor es Numero de Entrada
Algoritmo
	/*
	var w = $entrada.grosor >= 0 ? $entrada.grosor : 0;
  var c = document.getElementById("canvas");
  var ctx = c.getContext("2d");
  //lineWidth = w;
	ctx.lineWidth = w;
  */
Fin

Subrutina Primitiva colorBorde
Datos
  r es Numero de entrada
  g es Numero de entrada
  b es Numero de entrada
Algoritmo
  /*
  var c = document.getElementById("canvas");
  var ctx = c.getContext("2d");
	$global.$estiloBordes = "rgb(" + $entrada.r + "," + $entrada.g + "," + $entrada.b + ")";
	ctx.strokeStyle = $global.$estiloBordes;
	//strokeAlpha = parseFloat(a);
  */
Fin

Subrutina Primitiva SinRelleno
Datos

Algoritmo
	/*
  delete $global.$estiloRelleno;
  */
Fin

Subrutina Primitiva SinBorde
Datos

Algoritmo
	/*
  delete $global.$estiloBordes;
  */
Fin

Subrutina Primitiva Delta
Datos
  resultado es Numero de salida
Algoritmo
	/*
  $global.lasttime = $global.lasttime || new Date();
  var l = new Date();
  $salida.resultado = (l - $global.lasttime)/1000;
  $global.lasttime = l;
  */
Fin

Subrutina Primitiva PosicionRaton
Datos
	posx es Numero de Salida
  posy es Numero de Salida
Algoritmo
	/*
	var p = $in.$ratonCanvas();
  $salida.posx = p[0];
  $salida.posy = p[1];
  */
Fin

Subrutina Primitiva Linea
Datos
	pos1x es Numero de Entrada
  pos1y es Numero de Entrada
  pos2x es Numero de Entrada
  pos2y es Numero de Entrada
Algoritmo
	/*
  var c = document.getElementById("canvas");
  var ctx = c.getContext("2d");
  ctx.beginPath();
  ctx.moveTo($entrada.pos1x, $entrada.pos1y);
  ctx.lineTo($entrada.pos2x, $entrada.pos2y);
  ctx.closePath();
  if ($global.$estiloBordes) {
    //ctx.globalAlpha = strokeAlpha;
    ctx.stroke();
  }
  */
Fin

Subrutina Inicio
Datos
	anteriorx es Numero Global
  anteriory es Numero Global
Algoritmo
	anteriorx <- 0
  anteriory <- 0
Fin

Subrutina Fotograma
Datos
  d es Numero
  px es Numero
  py es Numero
  anteriorx es Numero global
  anteriory es Numero global
Algoritmo
  delta [
    resultado -> d
  ]
  Fondo [
    r <- 0
    g <- 0
    b <- 0
  ]
  posicionraton [
    posx -> px
    posy -> py
  ]
  anteriorx <- anteriorx + d*(px - anteriorx)*3
  anteriory <- anteriory + d*(py - anteriory)*3
  colorrelleno [
    r <- 255
    g <- 255
    b <- 255
  ]
  elipse [
    centrox <- anteriorx
    centroy <- anteriory
    ancho <- 50
    alto <- 50
  ]
  colorBorde [
    r <- 255
    g <- 255
    b <- 255
  ]
  grosorBorde [
    grosor <- 3
  ]
  linea [
    pos1x <- anteriorx
    pos1y <- anteriory
    pos2x <- px
    pos2y <- py
  ]
Fin</textarea>
    <div class="v divisor"></div>
    <div class="compilation">
      <div class="visual minimized" onclick="return visualRestore(event,this);">
        <canvas id="canvas" width="100" height="100" onmousemove="return handleMouseMove(event);" onmouseover="return handleMouseOver(event);">Tu explorador no es compatible con canvas</canvas>
        <div class="minimize hidden" onclick="return visualMinimize(event,this);">[-]</div>
        <div class="maximize hidden" onclick="return visualMaximize(event,this);">[+]</div>
      </div>
      <div class="helparea" id="helparea">
      </div>
      <div class="h divisor"></div>
      <div class="output" id="output"></div>
      <input type="text" class="input" id="input" disabled="disabled">
      <div style="display: flex;">
        <button class="run" id="run">
          Empezar
        </button>
        <button class="continue" id="continue" disabled="disabled">
          Continuar
        </button>
      </div>
    </div>

    <script>
      window.onbeforeunload = function(e) {
        return '¿Estás seguro de que quieres abandonar el editor?';
      };
      var editor = CodeMirror.fromTextArea($("#editor").get(0), {
        lineNumbers: true,
        mode: "zl",
        tabSize: 2,
        identWithTabs: false,
        smartIdent: true,
        cursorBlinkRate: 0,
        styleActiveLine: true,
        matchBrackets: true
      });
      editor.on("change", function(cm, ev) {
        var movido = 0;
        for (var i = 0; i < ev.text.length; i++) {
          movido += ev.text[i].length;
        }
        for (var i = 0; i < ev.removed.length; i++) {
          movido -= ev.removed[i].length;
        }
        if (lastCompilation)
          lastCompilation.tabla.desplazarPosiciones(editor.indexFromPos(ev.from),movido);
        if (lasttimeout) {
          clearTimeout(lasttimeout);
        }
        lasttimeout = setTimeout(Compile, 250, editor.getValue());
        if (ev.origin === "+input" && /[a-zA-Z\.]/.test(ev.text)) {
          editor.showHint({
            completeSingle: false
          });
        }

      });
      editor.on("cursorActivity", function(){
        setTimeout(evaluar,20);
        return true;
      });

      function autocompletar() {
        editor.showHint();
      }

      var evaluando = false;
      editor.addKeyMap({
        "Ctrl-S": download,
        "Cmd-S": download,
        "Ctrl-F9": function(){evaluando = !evaluando;},
        "Cmd-F9": function(){evaluando = !evaluando;},
        "Ctrl-Space": autocompletar,
        "Cmd-Space": autocompletar,
        "Ctrl-Enter": autocompletar,
        "Cmd-Enter": autocompletar
      });

      function canvasEscala() {
        $("canvas").attr("width", window.innerWidth);
        $("canvas").attr("height", window.innerHeight);
        return true;
      }
      canvasEscala();

      function visualRestore(event, visual) {
        if ($(visual).hasClass("minimized")) {
          $(visual).removeClass("minimized");
          $(visual).children(".minimize, .maximize").removeClass("hidden");
          $("#helparea").addClass("hidden");
        }
        event.stopPropagation();
        return true;
      }

      function visualMinimize(event, minimize) {
        var $visual = $(minimize).parent();
        $visual.removeClass("fullscreen");
        $visual.addClass("minimized");
        $(minimize).addClass("hidden");
        $(".maximize").addClass("hidden");
        $("#helparea").removeClass("hidden");
        event.stopPropagation();
        return true;
      }

      function visualMaximize(event, maximize) {
        var $visual = $(maximize).parent();
        $visual.toggleClass("maximized");
        event.stopPropagation();
        return true;
      }

      function saltarAlCodigo(linea, posicion) {
        "use strict";
        editor.setCursor(linea,posicion);
        editor.focus();
        return true;
      }

      var lastjs = "";
      var lasttimeout = null;
      var lastCompilation = null;
      var minify = false;
      var errorLineas = [];

      var carga = null;
      $("#run").click(function() {
        if (!lastCompilation)
          return false;
        var compilation = $("#helparea").get(0);
        var zlcode = editor.getValue();
        if (!carga) {
          $("#run").html("Abortar");
          carga = zl.Cargar(lastjs);
          carga.$asincrono.inicio = lastCompilation.inicioAsincrono;
          carga.$asincrono.fotograma = lastCompilation.fotogramaAsincrono;
          carga.$alAcabar = function() {
            carga = null;
            $("#run").html("Empezar");
          }
          try {
            zl.Ejecutar(carga);
          } catch (e) {
            if (zl.error.esError(e)){
              var tarjeta = zl.error.obtenerMensajeHtml(e, zlcode);
              compilation.innerHTML = tarjeta.getHtml();
              for (var i = 0; i < tarjeta.lineasDeError().length; i++) {
                var x = tarjeta.lineasDeError()[i]-1;
                errorLineas.push(editor.addLineClass(x, "background", "CodeMirror-line-error"));
              }
            }
            else
              throw e;
          }
        } else {
          zl.Abortar(carga);
          carga = null;

          $("#run").html("Empezar");
          compilation.innerHTML = "";
        }
      });

      var continuarCallback;
      var ultimoEntorno;
      $("#continue").click(function() {
        $("#continue").prop('disabled', true);
        editor.removeLineClass(ultimaLineaPausar, "background", "CodeMirror-line-pausar");
        ultimoEntorno = null;
        continuarCallback(null, null);
      });

      function Compile(zlcode) {
        lasttimeout = null;
        var compilation = $("#helparea").get(0);
        try {
          eliminarLineasError();
          lastCompilation = zl.Compilar(zlcode);
          zl.autocompletar.alimentarTabla(lastCompilation.tabla);
          if (minify)
            lastjs = js_beautify(uglify(js_beautify(lastCompilation.javascript)));
          else
            lastjs = js_beautify(lastCompilation.javascript);
          compilation.innerHTML = zl.escapeHtml(lastjs);
        } catch (e) {
          if (zl.error.esError(e)) {
            var tarjeta = zl.error.obtenerMensajeHtml(e, zlcode);
            compilation.innerHTML = tarjeta.getHtml();
            for (var i = 0; i < tarjeta.lineasDeError().length; i++) {
              var x = tarjeta.lineasDeError()[i]-1;
              errorLineas.push(editor.addLineClass(x, "background", "CodeMirror-line-error"));
            }
          }
          else
            throw e;
        }
      }

      function eliminarLineasError() {
        for (var i = 0; i < errorLineas.length; i++) {
          editor.removeLineClass(errorLineas[i], "background", "CodeMirror-line-error");
        }
        errorLineas = [];
      }

      Compile(editor.getValue());

      function download() {
        var zip = new JSZip();
        zip.file("codigo.zl",editor.getValue());
        zip.file("zl.comp.json", JSON.stringify({
          javascript: lastCompilation.javascript,
          inicioAsincrono: lastCompilation.inicioAsincrono,
          fotogramaAsincrono: lastCompilation.fotogramaAsincrono
        }));
        zip.file("estilo.css", zipestilo);
        zip.file("ejecucion.js", zipejecucion);
        zip.file("async.min.js", zipasync);
        zip.file("jquery-2.1.4.min.js", zipjquery);
        zip.file("utils.js", ziputils);
        zip.file("arrastrame a google chrome o firefox.html", zipindex);

        var content = zip.generate({type: "blob"});
        saveAs(content, "programa.zip");
      }

      var isBottom = true;
      $("#output").get(0).onscroll = function(ev) {
        $this = $("#output");
        var t = $this.get(0);
        isBottom = (t.scrollTop+$this.innerHeight() >= t.scrollHeight);
      };

      zl.io = zl.io || {};
      zl.io.lineas = [];

      zl.io.outWrite = function(html) {
        var t = $("#output").get(0);
        if (zl.io.lineas.length > 50) {
          zl.io.lineas = zl.io.lineas.slice(20);
          zl.io.lineas.push(zl.escapeHtml(html));
        } else {
          zl.io.lineas.push(zl.escapeHtml(html));
        }
        t.innerHTML = zl.io.lineas.join('');
        if (isBottom) {
          t.scrollTop = t.scrollHeight;
        }
      }

      zl.io.inRead = function(callback) {
        $("#input").prop("disabled",false);
        $("#input").keypress(function (e) {
          if (e.which == 13) {
            $(this).off("keypress");
            var v = $("#input").val();
            $("#input").val("");
            $("#input").prop('disabled', true);
            callback(null, v);
          }
        });
        $("#input").focus();
        evaluar();
      }

      zl.io.abortRead = function() {
        $("#input").off("keypress");
        $("#input").val("");
        $("#input").prop('disabled', true);
      }

      zl.io.limpiar = function() {
        $("#output").get(0).innerHTML = "";
        zl.io.lineas = [];
      }

      zl.io.pause = function($local, $global, $entrada, $salida, pos, callback) {
        var cursor = editor.posFromIndex(pos);
        $("#continue").prop('disabled', false);
        continuarCallback = callback;
        ultimoEntorno = [$local, $global, $entrada, $salida];
        ultimaLineaPausar = cursor.line;
        editor.addLineClass(ultimaLineaPausar, "background", "CodeMirror-line-pausar");
        saltarAlCodigo(cursor.line, cursor.ch);
        evaluar();
      }

      zl.io.abortPause = function() {
        $("#continue").prop('disabled', true);
        editor.removeLineClass(ultimaLineaPausar, "background", "CodeMirror-line-pausar");
      }

      var mouseX = 0;
      var mouseY = 0;
      var canvas = document.getElementById("canvas");
      zl.io.posicionRatonCanvas = function() {
        return [mouseX, mouseY];
      }

      var handleMouseMove = function(e) {
        var rect = canvas.getBoundingClientRect();
        mouseX = (e.clientX - rect.left) / (rect.right - rect.left) * canvas.width;
        mouseY = (e.clientY - rect.top) / (rect.bottom - rect.top) * canvas.height;
        return true;
      };

      var handleMouseOver = function(e) {
        var rect = canvas.getBoundingClientRect();
        mouseX = (e.clientX - rect.left) / (rect.right - rect.left) * canvas.width;
        mouseY = (e.clientY - rect.top) / (rect.bottom - rect.top) * canvas.height;
        return true;
      };

      function evaluar() {
        if (evaluando && carga && lastCompilation && ultimoEntorno) {
          var subrutina = lastCompilation.tabla.subrutinaPorPosicion(editor.indexFromPos(editor.getCursor()));
          var compilation = $("#helparea").get(0);
          var valor = zl.Evaluar(editor.getSelection(), subrutina, carga, ultimoEntorno);
          if (typeof valor === "undefined") {
            valor = "Desconocido/Sin valor";
          }
          compilation.innerHTML = "La expresión \n\t"+editor.getSelection()+"\n"+
            "Equivale a:\n"+valor;
        }
      }

      var zipindex;
      var zipestilo;
      var zipasync;
      var zipjquery;
      var ziputils;
      $.ajax("entornoEjecucion/estilo.css",{
        dataType: "text",
        type: "get",
        success: function(data) {
          zipestilo = data;
        }
      });

      $.ajax("entornoEjecucion/index.html",{
        dataType: "text",
        type: "get",
        success: function(data) {
          zipindex = data;
        }
      });

      $.ajax("ejecucion.js",{
        dataType: "text",
        type: "get",
        success: function(data) {
          zipejecucion = data;
        }
      });

      $.ajax("terceros/jquery-2.1.4.min.js",{
        dataType: "text",
        type: "get",
        success: function(data) {
          zipjquery = data;
        }
      });

      $.ajax("terceros/async.min.js",{
        dataType: "text",
        type: "get",
        success: function(data) {
          zipasync = data;
        }
      });

      $.ajax("utils.js",{
        dataType: "text",
        type: "get",
        success: function(data) {
          ziputils = data;
        }
      });
    </script>
</body>

</html>
